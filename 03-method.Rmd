---
output: html_document
editor_options: 
  chunk_output_type: console
---
# Methods
```{r setup}
library(tidyverse)
library(readxl)
library(ggplot2)
library(ggpmisc)
library(scales)
library(DT)
library(dplyr)
library(devEMF)
library(zoo)
```

We describe our methods in this chapter.

## Creating Conservation/Kalman Filter Function
```{r kalman_function}

```


## Data
Read in the data. 

```{r load_data}
layton <- read_excel("data/layton_counts.xlsx")
# read data from other places later.



  
```


## Calculating Kalman Filter

```{r kalman_apply}
# calculate kalman filter
estimated_queues <- detector %>%
  mutate(
    day = lubridate::wday(Start_time)
  ) %>%
  group_by(day) %>%
  mutate(
    kalman = kalman_filter(v_in, v_out, occupancy, ramp_length = 537)
    
  ) %>%
  ungroup() %>%
  select(Start_time, Queue_size, kalman)
```


```{r rmse_function}

```


```{r kalman_optim}

rmse_kalman(0.22, detector)
rmse_kalman(0,detector)

# Optimize:
# Find the values of C and K that will minimize the objective function
optim(c(0.22), rmse_kalman, df = detector)
```


```{r split}
rmse022 <- function(df){rmse_kalman(0.22, df)}

optim_k <- function(df){
  optim_results <- optim(c(0.22), rmse_kalman, df = df)
  optim_results$par
}


optim_rmse <- function(df){
  optim_results <- optim(c(0.22), rmse_kalman, df = df)
  optim_results$value
}

optim_rmse(detector)

optimal_values <- detector %>%
  mutate(dow = lubridate::day(`Start_time`)) %>%
  group_by(dow) %>%
  nest() %>%
  mutate(
    rmse_at_22 = map_dbl(data, rmse022),
    optim_k = map_dbl(data, optim_k),
    optim_rmse = map_dbl(data, optim_rmse)
    
  )
```


## Manual vs. Detector EQ Plot
```{r layton EQ, warning=FALSE, message=FALSE, results=FALSE}

# Compare EQ Detector and Manual Counts
formula1 <- y ~ x
eq1 <- ggplot(detector,aes(Manual_EQ_Tot,Detector_EQ_Tot)) + 
  geom_jitter() +  
  xlab("EQ Manual Count Volume (veh/min)") + ylab("EQ Detector Volume (veh/min)") +
  geom_smooth(method="lm",se=FALSE) +
  stat_poly_eq(formula=formula1,aes(label=paste(..eq.label..,..rr.label..,sep="~~~")),parse=TRUE) + 
  scale_x_continuous(breaks=c(0,5,10,15,20,25))
  scale_y_continuous(breaks=c(0,5,10,15,20,25))
  print(eq1)
```

## Manual vs. Detector PQ Plot
```{r layton PQ, warning=FALSE, message=FALSE, results=FALSE}

# Compare PQ Detector and Manual Counts
formula2 <- y ~ x
eq2 <- ggplot(detector,aes(Q_out,v_out)) + 
  geom_jitter() +  
  xlab("PQ Manual Count Volume (veh/min)") + ylab("PQ Detector Volume (veh/min)") +
  geom_smooth(method="lm",se=FALSE) +
  stat_poly_eq(formula=formula2,aes(label=paste(..eq.label..,..rr.label..,sep="~~~")),parse=TRUE) + 
  scale_x_continuous(breaks=c(0,5,10,15,20,25))
  scale_y_continuous(breaks=c(0,5,10,15,20,25))
  print(eq2)
```


## Conservation Model Plot
```{r layton Manual vs. Conservation Model, warning=FALSE, message=FALSE}

detector %>% 
  mutate(day = lubridate::day(Start_time)) %>%
  left_join(optimal_values %>% select(day = dow, optim_k), by = "day") %>%
  group_by(day) %>%
  #filter(day %in% c(21)) %>%
  transmute(`Start time` = Start_time, 
            Model = kalman_filter(v_in, v_out, occupancy, K = 0, ramp_length = 537),
            Manual = Queue_size) %>%
 gather(key = "Legend", value = "Queue Size", -`Start time`, -day)  %>%
ggplot(aes(x = `Start time`, y = `Queue Size`, color = `Legend`)) + 
  geom_line() +
  facet_wrap(~day, scales = "free") +
  ggtitle("Manual vs Estimated Counts Using Conservation Model") 
  #scale_y_continuous(breaks=c(0,2,4,6,8,10,12,14,16,18,20,22,24,26,28,30,32)) 
```


## Kalman Filter Model Plot
```{r layton Manual vs. Kalman Filter Model, warning=FALSE, message=FALSE}

detector %>% 
  mutate(day = lubridate::day(Start_time)) %>%
  left_join(optimal_values %>% select(day = dow, optim_k), by = "day") %>%
  group_by(day) %>%
  #filter(day %in% c(21)) %>% 
  transmute(`Start time` = Start_time, 
            Model = kalman_filter(v_in, v_out, occupancy, K = optim_k[1], ramp_length = 537),
            Manual = Queue_size,
            day = str_c(day, ", k = ", round(optim_k, 4))) %>%
 gather(key = "Legend", value = "Queue Size", -`Start time`, -day)  %>%
ggplot(aes(x = `Start time`, y = `Queue Size`, color = `Legend`)) + 
  geom_line() +
  facet_wrap(~day, scales = "free") +
  ggtitle("Manual vs Estimated Counts Using Kalman Filter Model") 
  #scale_y_continuous(breaks=c(0,2,4,6,8,10,12,14,16,18,20,22,24,26,28,30,32))
```

## Both
```{r layton Manual vs. Conservation and Kalman Filter Model, warning=FALSE, message=FALSE}

detector %>% 
  mutate(day = lubridate::day(Start_time)) %>%
  left_join(optimal_values %>% select(day = dow, optim_k), by = "day") %>%
  group_by(day) %>%
  filter(day %in% c(21)) %>% 
  transmute(`Start time` = Start_time, 
            Conservation = kalman_filter(v_in, v_out, occupancy, K = 0, ramp_length = 537),
            Kalman = kalman_filter(v_in, v_out, occupancy, K = optim_k[1], ramp_length = 537),
            Manual = Queue_size,
            day = str_c(day, ", k = ", round(optim_k, 4))) %>%
 gather(key = "Legend", value = "Queue Size", -`Start time`, -day)  %>%
ggplot(aes(x = `Start time`, y = `Queue Size`, color = `Legend`)) + 
  geom_line() +
  facet_wrap(~day, scales = "free") +
  ggtitle("Manual vs Estimated Counts Using Kalman Filter Model") 
  #scale_y_continuous(breaks=c(0,2,4,6,8,10,12,14,16,18,20,22,24,26,28,30,32))

```
